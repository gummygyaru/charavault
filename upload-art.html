<body>
  <div class="form-container">
    <h1>Submit Art</h1>
    <form id="art-upload-form">
      <label for="art-file">Upload Image</label>
      <input type="file" id="art-file" accept="image/png, image/jpeg, image/gif" required />
      <div class="info-text">Images may be PNG, GIF, or JPG and up to 4MB in size.</div>

      <label for="caption">Caption (optional)</label>
      <textarea id="caption" rows="3" placeholder="Add a caption or description..."></textarea>

      <label for="authorized-viewers">Authorized Viewers (Privacy)</label>
      <select id="authorized-viewers" required>
        <option value="private">Private</option>
        <option value="friends">Friends Only</option>
        <option value="public">Public</option>
      </select>

      <label for="public-viewers">Public Viewers</label>
      <select id="public-viewers" required>
        <option value="full-size">Full-Size</option>
        <option value="watermarked" selected>Watermarked</option>
      </select>

      <label for="watermark">Watermark</label>
      <input type="text" id="watermark" placeholder="Default: gummygyaru" value="gummygyaru" />

      <small><a href="#">See Watermark Settings for privacy defaults and custom watermarks.</a></small>

      <fieldset style="margin-top: 1rem;">
        <legend><strong>NSFW Settings</strong></legend>
        <div class="checkbox-group">
          <label><input type="checkbox" id="sexual-content" /> Sexual Content</label>
          <label><input type="checkbox" id="nudity" /> Nudity</label>
          <label><input type="checkbox" id="gore" /> Gore</label>
          <label><input type="checkbox" id="sensitive" /> Sensitive Content</label>
        </div>
      </fieldset>

      <label for="characters-featured">Characters Featured (comma-separated usernames or links)</label>
      <input type="text" id="characters-featured" placeholder="shimura, otheruser, https://..." />

      <label for="artist-credit-onsite">On-site Artist Credit (username)</label>
      <input type="text" id="artist-credit-onsite" placeholder="shimura" />

      <label for="artist-credit-offsite">Off-site Artist Credit (link)</label>
      <input type="url" id="artist-credit-offsite" placeholder="https://artistwebsite.com" />

      <small style="color: #d14343; margin-top: 1rem; display: block;">
        Do not use images you do not have permission to use. Please read the rules for information on image usage and crediting. Art theft will not be tolerated.
      </small>

      <button type="submit">Submit Art</button>
    </form>

    <div id="upload-message" style="margin-top: 1rem; font-weight: bold;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDDZvaWl5qwJbvPOHN1pisGwfIN2gkj1Ec",
      authDomain: "charavault-e8cf5.firebaseapp.com",
      projectId: "charavault-e8cf5",
      storageBucket: "charavault-e8cf5.appspot.com",
      messagingSenderId: "385710051091",
      appId: "1:385710051091:web:a38d5ac0047ec32a0914e6",
      measurementId: "G-JNLB26DXJC",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    const form = document.getElementById("art-upload-form");
    const message = document.getElementById("upload-message");

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        message.textContent = "You must be logged in to submit art.";
        form.style.display = "none";
        return;
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        message.textContent = "Uploading...";

        const fileInput = document.getElementById("art-file");
        const file = fileInput.files[0];

        if (!file) {
          message.textContent = "Please select an art file.";
          return;
        }

        if (file.size > 4 * 1024 * 1024) {
          message.textContent = "File size must be 4MB or less.";
          return;
        }

        try {
          // Upload image to Firebase Storage
          const storageRef = ref(storage, `art/${user.uid}/${Date.now()}_${file.name}`);
          await uploadBytes(storageRef, file);
          const fileURL = await getDownloadURL(storageRef);

          // Add Firestore doc
          await addDoc(collection(db, "artworks"), {
            uid: user.uid,
            title: file.name,
            caption: document.getElementById("caption").value,
            authorizedViewers: document.getElementById("authorized-viewers").value,
            publicViewers: document.getElementById("public-viewers").value,
            watermark: document.getElementById("watermark").value || "gummygyaru",
            nsfwSettings: {
              sexualContent: document.getElementById("sexual-content").checked,
              nudity: document.getElementById("nudity").checked,
              gore: document.getElementById("gore").checked,
              sensitiveContent: document.getElementById("sensitive").checked,
            },
            charactersFeatured: document.getElementById("characters-featured").value.split(",").map(s => s.trim()).filter(Boolean),
            artistCreditOnsite: document.getElementById("artist-credit-onsite").value,
            artistCreditOffsite: document.getElementById("artist-credit-offsite").value,
            imageUrl: fileURL,
            timestamp: serverTimestamp(),
          });

          message.textContent = "✅ Art submitted successfully!";
          form.reset();
        } catch (err) {
          console.error("Error uploading art:", err);
          message.textContent = "❌ Error: " + err.message;
        }
      });
    });
  </script>
</body>
</html>
