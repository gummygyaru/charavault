<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Settings - chara.vault</title>
  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css"/>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f4f4f8;
      padding: 2rem;
    }

    .settings-section {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      margin: auto;
    }

    label {
      font-weight: bold;
      margin-bottom: 0.5rem;
      display: block;
    }

    input[type="file"] {
      margin-top: 0.5rem;
    }

    #crop-area {
      margin-top: 1rem;
      max-width: 300px;
      max-height: 300px;
    }

    #avatar-preview {
      margin-top: 1rem;
      width: 200px;
      height: 200px;
      object-fit: cover;
      border: 2px solid #ccc;
      border-radius: 8px;
    }

    #message {
      margin-top: 1rem;
      font-weight: bold;
      color: #e11d48;
    }

    #message.success {
      color: #10b981;
    }

    button {
      margin-top: 1rem;
      background: #9333ea;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover {
      background: #7e22ce;
    }
  </style>
</head>
<body>
  <div class="settings-section">
    <h2>Upload Avatar</h2>
    <label for="avatar-upload">Choose an image (PNG, JPG, GIF):</label>
    <input type="file" id="avatar-upload" accept="image/png, image/jpeg, image/gif" />
    
    <div>
      <img id="crop-area" style="display: none;" />
    </div>

    <button id="crop-upload" style="display: none;">Crop & Upload</button>

    <img id="avatar-preview" src="../default-avatar.png" alt="Your Avatar" />
    <p id="message"></p>
  </div>

  <!-- Firebase + Cropper -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDDZvaWl5qwJbvPOHN1pisGwfIN2gkj1Ec",
      authDomain: "charavault-e8cf5.firebaseapp.com",
      projectId: "charavault-e8cf5",
      storageBucket: "charavault-e8cf5.appspot.com",
      messagingSenderId: "385710051091",
      appId: "1:385710051091:web:a38d5ac0047ec32a0914e6",
      measurementId: "G-JNLB26DXJC"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let cropper;
    const uploadInput = document.getElementById("avatar-upload");
    const cropArea = document.getElementById("crop-area");
    const cropBtn = document.getElementById("crop-upload");
    const preview = document.getElementById("avatar-preview");
    const message = document.getElementById("message");

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        window.location.href = "../login.html";
        return;
      }

      uploadInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
          cropArea.src = event.target.result;
          cropArea.style.display = "block";
          cropBtn.style.display = "inline-block";

          if (cropper) cropper.destroy();
          cropper = new Cropper(cropArea, {
            aspectRatio: 1,
            viewMode: 1,
            autoCropArea: 1,
          });
        };
        reader.readAsDataURL(file);
      });

      cropBtn.addEventListener("click", async () => {
        try {
          const canvas = cropper.getCroppedCanvas({
            width: 200,
            height: 200,
          });

          const blob = await new Promise((resolve) => canvas.toBlob(resolve, "image/png"));
          const avatarRef = ref(storage, `avatars/${user.uid}`);
          await uploadBytes(avatarRef, blob);
          const url = await getDownloadURL(avatarRef);

          preview.src = url;
          message.textContent = "✅ Avatar uploaded!";
          message.className = "success";

          // Hide cropper
          cropArea.style.display = "none";
          cropBtn.style.display = "none";
          cropper.destroy();
        } catch (err) {
          message.textContent = "⚠️ " + err;
          message.classList.remove("success");
        }
      });
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
</body>
</html>
