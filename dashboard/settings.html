<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload Avatar - chara.vault</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      padding: 2rem;
      background: #f4f4f8;
    }
    input[type="file"] {
      margin-bottom: 1rem;
    }
    img {
      border-radius: 12px;
      width: 200px;
      height: 200px;
      object-fit: cover;
      border: 2px solid #9333ea;
      display: block;
      margin-bottom: 1rem;
    }
    button {
      background: #9333ea;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover {
      background: #7e22ce;
    }
    #message {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>Change your Avatar</h2>

  <img id="avatarPreview" src="" alt="Your Avatar Preview" />

  <input type="file" id="avatarInput" accept="image/png, image/jpeg, image/gif" />
  <br />
  <button id="uploadBtn">Upload Avatar</button>

  <p id="message"></p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDDZvaWl5qwJbvPOHN1pisGwfIN2gkj1Ec",
      authDomain: "charavault-e8cf5.firebaseapp.com",
      projectId: "charavault-e8cf5",
      storageBucket: "charavault-e8cf5.firebasestorage.app",
      messagingSenderId: "385710051091",
      appId: "1:385710051091:web:a38d5ac0047ec32a0914e6",
      measurementId: "G-JNLB26DXJC",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const firestore = getFirestore(app);

    const avatarInput = document.getElementById("avatarInput");
    const avatarPreview = document.getElementById("avatarPreview");
    const uploadBtn = document.getElementById("uploadBtn");
    const messageEl = document.getElementById("message");

    let selectedFile = null;

    avatarInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;

      if (!["image/png", "image/jpeg", "image/gif"].includes(file.type)) {
        messageEl.textContent = "⚠️ Please select a PNG, JPEG, or GIF image.";
        return;
      }

      selectedFile = file;

      // Show preview
      const reader = new FileReader();
      reader.onload = (event) => {
        avatarPreview.src = event.target.result;
        messageEl.textContent = "";
      };
      reader.readAsDataURL(file);
    });

    // Helper to convert file to Base64 string (without data prefix)
    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          // remove "data:image/xxx;base64," prefix
          const base64 = reader.result.split(",")[1];
          resolve(base64);
        };
        reader.onerror = (error) => reject(error);
        reader.readAsDataURL(file);
      });
    }

    uploadBtn.addEventListener("click", async () => {
      if (!selectedFile) {
        messageEl.textContent = "⚠️ Please select an image first.";
        return;
      }

      messageEl.textContent = "Uploading...";

      try {
        // Wait for user login
        const user = auth.currentUser;
        if (!user) {
          messageEl.textContent = "⚠️ You must be logged in.";
          return;
        }

        // Convert to base64 string
        const base64String = await fileToBase64(selectedFile);

        // Update Firestore user document
        const userDocRef = doc(firestore, "users", user.uid);

        await updateDoc(userDocRef, {
          avatarBase64: base64String,
          avatarUpdatedAt: new Date()
        });

        messageEl.textContent = "✅ Avatar uploaded successfully!";
      } catch (err) {
        messageEl.textContent = "⚠️ Error uploading avatar: " + err.message;
      }
    });

    // Load current avatar when page loads
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const userDocRef = doc(firestore, "users", user.uid);
        const docSnap = await getDoc(userDocRef);
        if (docSnap.exists()) {
          const data = docSnap.data();
          if (data.avatarBase64) {
            avatarPreview.src = "data:image/png;base64," + data.avatarBase64;
          } else {
            avatarPreview.src = ""; // Or default avatar image url
          }
        }
      } else {
        // Not logged in? Send to login page
        window.location.href = "login.html";
      }
    });
  </s
