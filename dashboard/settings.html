---
layout: default
title: Dashboard
---

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Settings | Dashboard</title>
  <link rel="stylesheet" href="https://gummygyaru.github.io/charavault/assets/css/base.css" />
  <!-- Theme CSS will be dynamically injected here -->
  <script type="module">
    import { getAuth, onAuthStateChanged, sendEmailVerification, sendPasswordResetEmail, updateEmail } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-storage.js";
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDDZvaWl5qwJbvPOHN1pisGwfIN2gkj1Ec",
      authDomain: "charavault-e8cf5.firebaseapp.com",
      projectId: "charavault-e8cf5",
      storageBucket: "charavault-e8cf5.appspot.com",
      messagingSenderId: "385710051091",
      appId: "1:385710051091:web:a38d5ac0047ec32a0914e6"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const $ = (id) => document.getElementById(id);

    const themeMap = {
      "Fire Vault": "https://gummygyaru.github.io/charavault/assets/css/themes/fire-vault.css",
      "Moon Vault": "https://gummygyaru.github.io/charavault/assets/css/themes/moon-vault.css",
      "Ocean Vault": "https://gummygyaru.github.io/charavault/assets/css/themes/ocean-vault.css",
      "Forest Vault": "https://gummygyaru.github.io/charavault/assets/css/themes/forest-vault.css"
    };

    function applyTheme(themeName) {
      let linkTag = document.getElementById("theme-link");
      if (!linkTag) {
        linkTag = document.createElement("link");
        linkTag.rel = "stylesheet";
        linkTag.id = "theme-link";
        document.head.appendChild(linkTag);
      }
      linkTag.href = themeMap[themeName] || themeMap["Fire Vault"];
      if ($("site-theme")) $("site-theme").value = themeName;
      localStorage.setItem("selectedTheme", themeName);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "/login.html";

      const userRef = doc(db, "users", user.uid);
      const snap = await getDoc(userRef);

      const savedTheme = (snap.exists() && snap.data().theme) || localStorage.getItem("selectedTheme") || "Fire Vault";
      applyTheme(savedTheme);

      if (snap.exists()) {
        const data = snap.data();
        if (data.username) $("username-input").value = data.username;
        if (data.dob) $("dob").value = data.dob;
        if (data.customCSS) $("custom-css").value = data.customCSS;
        if (data.avatarURL) $("avatar-preview").src = data.avatarURL;
      }
      $("email-input").value = user.email;

      $("avatar").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => $("avatar-preview").src = reader.result;
          reader.readAsDataURL(file);
        }
      });

      $("site-theme").addEventListener("change", async (e) => {
        const newTheme = e.target.value;
        applyTheme(newTheme);

        try {
          await setDoc(userRef, { theme: newTheme }, { merge: true });
          $("message").textContent = `Theme changed to ${newTheme}`;
        } catch (err) {
          $("message").textContent = `Failed to save theme: ${err.message}`;
        }
      });

      $("save-btn").addEventListener("click", async () => {
        $("message").textContent = "Saving...";
        const username = $("username-input").value.trim();
        const dob = $("dob").value;
        const theme = $("site-theme").value;
        const customCSS = $("custom-css").value;

        const dataToUpdate = { username, dob, theme, customCSS };

        try {
          const file = $("avatar").files[0];
          if (file) {
            const storageRef = ref(storage, `avatars/${user.uid}`);
            await uploadBytes(storageRef, file);
            const url = await getDownloadURL(storageRef);
            dataToUpdate.avatarURL = url;
          }

          await setDoc(userRef, dataToUpdate, { merge: true });
          $("message").textContent = "Settings saved!";
        } catch (err) {
          $("message").textContent = `Error: ${err.message}`;
        }
      });

      $("change-email-btn").addEventListener("click", async () => {
        try {
          const newEmail = $("email-input").value.trim();
          await updateEmail(user, newEmail);
          await sendEmailVerification(user);
          $("message").textContent = "Email updated. Verification sent.";
        } catch (err) {
          $("message").textContent = `Email change failed: ${err.message}`;
        }
      });

      $("reset-password-btn").addEventListener("click", async () => {
        try {
          await sendPasswordResetEmail(auth, user.email);
          $("message").textContent = "Password reset email sent.";
        } catch (err) {
          $("message").textContent = `Reset failed: ${err.message}`;
        }
      });
    });

    window.addEventListener("load", () => {
      if (!auth.currentUser) {
        const savedTheme = localStorage.getItem("selectedTheme") || "Fire Vault";
        applyTheme(savedTheme);
      }
    });
  </script>
</head>
<body>
  <main id="main-content" style="max-width:600px; margin:2rem auto; font-family:sans-serif;">
    <h2>Account Settings</h2>
    <label for="avatar">Change Avatar (png, jpeg, gif, max 200x200)</label><br />
    <input type="file" id="avatar" accept="image/png, image/jpeg, image/gif" /><br />
    <img id="avatar-preview" alt="Avatar Preview" style="max-width:200px; max-height:200px; margin: 1rem 0; border-radius:8px;" />

    <label for="username-input">Username (change once a month only)</label><br />
    <input type="text" id="username-input" placeholder="Your username" style="width:100%; padding:0.5rem; margin-bottom:1rem;" />

    <label for="dob">Date of Birth</label><br />
    <input type="date" id="dob" style="width:100%; padding:0.5rem; margin-bottom:1rem;" />

    <label for="email-input">Email</label><br />
    <input type="email" id="email-input" placeholder="Your email" style="width:100%; padding:0.5rem; margin-bottom:0.5rem;" />
    <button id="change-email-btn" style="margin-bottom:1rem;">Change Email (verification sent)</button><br />

    <label>Password</label><br />
    <button id="reset-password-btn" style="margin-bottom:1rem;">Send Password Reset Email</button><br />

    <label for="site-theme">Site Theme</label><br />
    <select id="site-theme" style="width:100%; padding:0.5rem; margin-bottom:1rem;">
      <option value="Fire Vault">Fire Vault</option>
      <option value="Moon Vault">Moon Vault</option>
      <option value="Ocean Vault">Ocean Vault</option>
      <option value="Forest Vault">Forest Vault</option>
    </select>

    <label for="custom-css">Custom Theme CSS (only you see this)</label><br />
    <textarea id="custom-css" rows="6" placeholder="Enter your custom CSS here..." style="width:100%; padding:0.5rem; margin-bottom:1rem;"></textarea>

    <button id="save-btn" style="padding:0.75rem 1.5rem; font-size:1rem;">Save Settings</button>

    <div id="message" style="margin-top:1rem; color:green;"></div>
  </main>
</body>
</html>
